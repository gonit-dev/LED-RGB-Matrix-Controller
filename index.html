<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LED RGB Matrix Controller</title>
    <link rel="stylesheet" href="css/foundation.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #5c87ff;
            min-height: 100vh;
            padding: 20px;
        }

        .grid-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
            max-width: 1200px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .controls-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .controls-section label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .main-content {
            margin-bottom: 30px;
        }

        .preview {
            background: #f8f9fa !important;
            border: none !important;
        }

        .preview h2 {
            color: #333;
            font-size: 20px;
            margin: 0;
        }

        .led-grid-container {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            display: inline-block;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
            overflow: auto;
            max-width: 100%;
            max-height: 500px;
        }

        .led-grid {
            display: grid;
            gap: 4px;
        }

        .led {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #555;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid #444;
            position: relative;
        }

        .led:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .led.selected {
            box-shadow: 0 0 15px currentColor;
            border-color: currentColor;
        }

        .led-number {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8px;
            color: white;
            font-weight: bold;
            pointer-events: none;
            text-shadow: 0 0 3px black;
        }

        .color-palette {
            background: #f8f9fa !important;
            border: none !important;
            margin-bottom: 20px;
        }

        .color-palette h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .palette-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-item {
            width: 45px;
            height: 45px;
            border-radius: 8px;
            cursor: grab;
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .color-item:active {
            cursor: grabbing;
        }

        .color-item:hover {
            transform: scale(1.1);
            border-color: white;
            box-shadow: 0 0 15px currentColor;
        }

        .color-item.active {
            border-color: white;
            box-shadow: 0 0 20px currentColor;
        }

        .custom-color {
            margin-top: 10px;
            align-items: center;
        }

        .custom-color input[type="color"] {
            width: 60px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .custom-color input[type="text"] {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            margin: 0;
        }

        .selection-panel {
            background: #f8f9fa !important;
            border: none !important;
        }

        .selection-panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .button-group {
            margin-bottom: 15px;
        }

        .button-group .button {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .button.warning {
            background: #f59e0b;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .button.warning:hover {
            background: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }

        .selected-list {
            max-height: 250px;
            overflow-y: auto;
            background: white;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ddd;
        }

        .selected-item {
            padding: 8px;
            background: #e0e7ff;
            margin-bottom: 5px;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .selected-item-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #333;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
        }

        .remove-btn:hover {
            background: #dc2626;
        }

        .info-box {
            background: #e0e7ff !important;
            border-left: 4px solid #667eea !important;
            padding: 15px;
            border-radius: 5px;
            font-size: 14px;
            color: #4338ca;
            margin-bottom: 15px;
        }

        .wiring-diagram {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            margin-bottom: 15px;
            border: 2px solid #ddd;
            overflow-x: auto;
        }

        .wiring-diagram h4 {
            font-size: 12px;
            margin-bottom: 10px;
            color: #333;
        }

        .wire-example {
            font-family: 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            color: #333;
            white-space: pre;
            overflow-x: auto;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
        }

        .wire-line {
            margin: 1px 0;
        }

        .wire-data { 
            color: #ef4444; 
            font-weight: bold; 
        }

        .wire-arrow { 
            color: #667eea; 
            font-weight: bold; 
            font-size: 10px; 
        }

        .save-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #667eea;
        }

        .save-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .save-btn {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .save-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .save-btn.success {
            background: #10b981;
        }

        .save-btn.error {
            background: #ef4444;
        }

        .load-btn {
            background: #10b981;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .load-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
            display: block;
        }

        .status-message.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
            display: block;
        }

        .brightness-control {
            margin-top: 15px;
        }

        .brightness-control input[type="range"] {
            width: 100%;
        }

        .brightness-value {
            text-align: center;
            font-weight: 600;
            color: #667eea;
            margin-top: 5px;
        }

        @media screen and (max-width: 640px) {
            .grid-container {
                padding: 15px;
            }
            
            h1 {
                font-size: 22px;
            }
            
            .palette-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .led-grid-container {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="grid-container">
        <div class="cell small-12 medium-12 large-12">
            <div class="grid-x grid-padding-x">
                <div class="cell">
                    <h1>üé® LED RGB Matrix Controller</h1>
                    <p class="subtitle">Drag & Drop warna ke LED atau klik LED lalu pilih warna</p>
                </div>
            </div>

            <!-- Controls -->
            <div class="grid-x grid-padding-x controls-section">
                <div class="cell small-12 medium-6 large-3">
                    <label for="rows">Jumlah Strip Horizontal:
                        <input type="number" id="rows" value="3" min="1" max="20">
                    </label>
                </div>
                <div class="cell small-12 medium-6 large-3">
                    <label for="cols">Jumlah Strip Vertikal:
                        <input type="number" id="cols" value="3" min="1" max="20">
                    </label>
                </div>
                <div class="cell small-12 medium-6 large-3">
                    <label for="ledsPerStrip">LED per Strip:
                        <input type="number" id="ledsPerStrip" value="10" min="1" max="100">
                    </label>
                </div>
                <div class="cell small-12 medium-6 large-3">
                    <label for="startCorner">Titik Awal:
                        <select id="startCorner">
                            <option value="0">Kiri Bawah</option>
                            <option value="1">Kanan Bawah</option>
                            <option value="2">Kiri Atas</option>
                            <option value="3">Kanan Atas</option>
                        </select>
                    </label>
                </div>
            </div>

            <!-- Main Content -->
            <div class="grid-x grid-padding-x main-content">
                <!-- Preview -->
                <div class="cell small-12 large-8">
                    <div class="preview callout">
                        <div class="grid-x align-justify">
                            <div class="cell auto">
                                <h2>üì≤ LED Matrix</h2>
                            </div>
                            <div class="cell shrink">
                                <label>
                                    <input type="checkbox" id="zigzag" checked>
                                    Mode Zigzag
                                </label>
                            </div>
                        </div>
                        <div id="zigzagInfo"></div>
                        <div class="led-grid-container">
                            <div id="ledGrid" class="led-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="cell small-12 large-4">
                    <!-- Color Palette -->
                    <div class="callout color-palette">
                        <h3>üé® Palet Warna</h3>
                        <div class="palette-grid" id="colorPalette"></div>
                        <div class="grid-x grid-padding-x custom-color">
                            <div class="cell shrink">
                                <input type="color" id="customColor" value="#ff0080">
                            </div>
                            <div class="cell auto">
                                <input type="text" id="hexInput" value="#ff0080" placeholder="#RRGGBB">
                            </div>
                        </div>
                    </div>

                    <!-- Brightness Control -->
                    <div class="callout">
                        <h3>üí° Kecerahan</h3>
                        <div class="brightness-control">
                            <input type="range" id="brightness" min="10" max="255" value="50">
                            <div class="brightness-value" id="brightnessValue">50</div>
                        </div>
                    </div>

                    <!-- Selection Panel -->
                    <div class="callout selection-panel">
                        <h3>‚ú® LED Terpilih</h3>
                        <div class="button-group">
                            <button class="button primary" onclick="selectAll()">Pilih Semua</button>
                            <button class="button alert" onclick="clearSelection()">Hapus Semua</button>
                        </div>
                        <div class="callout info-box">
                            <strong>Total Terpilih:</strong> <span id="selectedCount">0</span> LED<br>
                            <strong>Total LED:</strong> <span id="totalLeds">0</span>
                        </div>
                        <div class="selected-list" id="selectedList"></div>
                    </div>
                </div>
            </div>

            <!-- Save/Load Section -->
            <div class="save-section">
                <h3>üíæ Simpan & Muat Konfigurasi</h3>
                <div class="button-group">
                    <button class="save-btn" onclick="saveToArduino()">üíæ Simpan ke Arduino</button>
                    <button class="save-btn" onclick="cancelChanges()">üîÑ Batal</button>
                </div>
                <div class="status-message" id="statusMessage"></div>
                
                <div class="info-box" style="margin-top: 15px;">
                    <strong>üìä Data Tersimpan di Arduino:</strong><br>
                    ‚Ä¢ Strip Horizontal: <span id="savedRows">-</span><br>
                    ‚Ä¢ Strip Vertikal: <span id="savedCols">-</span><br>
                    ‚Ä¢ LED per Strip: <span id="savedLedsPerStrip">-</span><br>
                    ‚Ä¢ Titik Awal: <span id="savedStartCorner">-</span><br>
                    ‚Ä¢ Mode Zigzag: <span id="savedZigzag">-</span><br>
                    ‚Ä¢ Kecerahan: <span id="savedBrightness">-</span><br>
                    ‚Ä¢ Total LED: <span id="savedTotalLeds">-</span><br>
                    ‚Ä¢ Total Terpilih: <span id="savedSelectedCount">-</span><br>
                    ‚Ä¢ Grup Warna: <span id="savedGroups">-</span>
                </div>
            </div>
    </div>

    <script>
        let savedState = null;

        const state = {
            rows: 3,
            cols: 3,
            ledsPerStrip: 10,
            startCorner: 0,
            zigzag: true,
            brightness: 50,
            selectedLeds: {},
            coordinates: [],
            currentColor: '#ff0080'
        };

        const colorPalette = [
            { name: 'Merah', color: '#FF0000' },
            { name: 'Orange', color: '#FF8800' },
            { name: 'Kuning', color: '#FFFF00' },
            { name: 'Hijau', color: '#00FF00' },
            { name: 'Cyan', color: '#00FFFF' },
            { name: 'Biru', color: '#0000FF' },
            { name: 'Ungu', color: '#8800FF' },
            { name: 'Pink', color: '#FF0080' },
            { name: 'Putih', color: '#FFFFFF' },
            { name: 'Magenta', color: '#FF00FF' },
            { name: 'Lime', color: '#88FF00' },
            { name: 'Aqua', color: '#00FF88' }
        ];

        function updateSavedDataDisplay(config) {
            const startCornerNames = ['Kiri Bawah', 'Kanan Bawah', 'Kiri Atas', 'Kanan Atas'];
            
            document.getElementById('savedRows').textContent = config.rows;
            document.getElementById('savedCols').textContent = config.cols;
            document.getElementById('savedLedsPerStrip').textContent = config.ledsPerStrip;
            document.getElementById('savedStartCorner').textContent = startCornerNames[config.startCorner];
            document.getElementById('savedZigzag').textContent = config.zigzag ? 'Ya' : 'Tidak';
            document.getElementById('savedBrightness').textContent = config.brightness;
            document.getElementById('savedTotalLeds').textContent = config.numLeds;
            
            // Hitung total LED terpilih dari groups
            let totalSelected = 0;
            config.groups.forEach(group => {
                totalSelected += group.count;
            });
            
            document.getElementById('savedSelectedCount').textContent = totalSelected;
            document.getElementById('savedGroups').textContent = config.groups.length;
        }

        function cancelChanges() {
            if (savedState) {
                if (confirm('Batalkan semua perubahan dan kembali ke pengaturan Arduino sebelumnya?')) {
                    // Restore dari savedState
                    state.rows = savedState.rows;
                    state.cols = savedState.cols;
                    state.ledsPerStrip = savedState.ledsPerStrip;
                    state.brightness = savedState.brightness;
                    state.zigzag = savedState.zigzag;
                    state.startCorner = savedState.startCorner;

                    // Update form inputs
                    document.getElementById('rows').value = savedState.rows;
                    document.getElementById('cols').value = savedState.cols;
                    document.getElementById('ledsPerStrip').value = savedState.ledsPerStrip;
                    document.getElementById('brightness').value = savedState.brightness;
                    document.getElementById('brightnessValue').textContent = savedState.brightness;
                    document.getElementById('zigzag').checked = savedState.zigzag;
                    document.getElementById('startCorner').value = savedState.startCorner;

                    // Reconstruct selectedLeds from savedState groups
                    state.selectedLeds = {};
                    savedState.groups.forEach(group => {
                        const color = `#${group.r.toString(16).padStart(2, '0')}${group.g.toString(16).padStart(2, '0')}${group.b.toString(16).padStart(2, '0')}`.toUpperCase();
                        group.indices.forEach(idx => {
                            state.selectedLeds[idx] = color;
                        });
                    });

                    // Regenerate everything
                    generateCoordinates();
                    generatePreview();
                    updateSelectedList();
                    updateZigzagInfo();

                    showStatus('Perubahan dibatalkan, kembali ke pengaturan Arduino', 'success');
                }
            } else {
                alert('Belum ada konfigurasi tersimpan. Silakan simpan terlebih dahulu.');
            }
        }

        async function saveToArduino() {
            const btn = document.querySelector('.save-btn');
            btn.textContent = '‚è≥ Menyimpan...';
            btn.disabled = true;

            try {
                // Group LEDs by color
                const colorGroups = {};
                Object.entries(state.selectedLeds).forEach(([idx, color]) => {
                    if (!colorGroups[color]) {
                        colorGroups[color] = [];
                    }
                    colorGroups[color].push(parseInt(idx));
                });

                // Create groups array
                const groups = Object.entries(colorGroups).map(([color, indices]) => {
                    const rgb = hexToRgb(color);
                    return {
                        count: indices.length,
                        indices: indices.sort((a, b) => a - b),
                        r: rgb.r,
                        g: rgb.g,
                        b: rgb.b
                    };
                });

                const configData = {
                    rows: state.rows,
                    cols: state.cols,
                    ledsPerStrip: state.ledsPerStrip,
                    brightness: state.brightness,
                    zigzag: state.zigzag,
                    startCorner: state.startCorner,
                    numLeds: state.coordinates.length,
                    groups: groups
                };

                const response = await fetch('/api/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                const result = await response.json();

                if (result.success) {
                    btn.classList.add('success');
                    btn.textContent = '‚úì Tersimpan!';
                    showStatus('Konfigurasi berhasil disimpan ke Arduino!', 'success');
                    
                    // Simpan backup state
                    savedState = JSON.parse(JSON.stringify(configData));
                    
                    // Update display data tersimpan
                    updateSavedDataDisplay(configData);
                } else {
                    throw new Error(result.error || 'Gagal menyimpan');
                }
            } catch (error) {
                btn.classList.add('error');
                btn.textContent = '‚úó Gagal';
                showStatus('Error: ' + error.message, 'error');
            }

            setTimeout(() => {
                btn.textContent = 'üíæ Simpan ke Arduino';
                btn.classList.remove('success', 'error');
                btn.disabled = false;
            }, 2000);
        }

        async function loadFromArduino() {
            const btn = document.querySelector('.load-btn');
            if (btn) {
                btn.textContent = '‚è≥ Memuat...';
                btn.disabled = true;
            }

            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                // Update state from Arduino
                state.rows = config.rows;
                state.cols = config.cols;
                state.ledsPerStrip = config.ledsPerStrip;
                state.brightness = config.brightness;
                state.zigzag = config.zigzag;
                state.startCorner = config.startCorner;

                // Update form inputs
                document.getElementById('rows').value = config.rows;
                document.getElementById('cols').value = config.cols;
                document.getElementById('ledsPerStrip').value = config.ledsPerStrip;
                document.getElementById('brightness').value = config.brightness;
                document.getElementById('brightnessValue').textContent = config.brightness;
                document.getElementById('zigzag').checked = config.zigzag;
                document.getElementById('startCorner').value = config.startCorner;

                // Reconstruct selectedLeds from groups
                state.selectedLeds = {};
                config.groups.forEach(group => {
                    const color = `#${group.r.toString(16).padStart(2, '0')}${group.g.toString(16).padStart(2, '0')}${group.b.toString(16).padStart(2, '0')}`.toUpperCase();
                    group.indices.forEach(idx => {
                        state.selectedLeds[idx] = color;
                    });
                });

                // Regenerate everything
                generateCoordinates();
                generatePreview();
                updateSelectedList();
                updateZigzagInfo();

                // Simpan backup state agar tombol Batal bisa berfungsi
                savedState = JSON.parse(JSON.stringify(config));
                
                // Update display data tersimpan
                updateSavedDataDisplay(config);

                if (btn) {
                    btn.textContent = '‚úì Dimuat!';
                }
                showStatus('Konfigurasi berhasil dimuat dari Arduino!', 'success');
            } catch (error) {
                if (btn) {
                    btn.textContent = '‚úó Gagal';
                }
                showStatus('Error: ' + error.message, 'error');
                console.error('Load error:', error);
            }

            if (btn) {
                setTimeout(() => {
                    btn.textContent = 'üì• Muat dari Arduino';
                    btn.disabled = false;
                }, 2000);
            }
        }

        function initColorPalette() {
            const palette = document.getElementById('colorPalette');
            palette.innerHTML = colorPalette.map((c, i) => 
                `<div class="color-item" 
                      style="background: ${c.color}" 
                      data-color="${c.color}"
                      draggable="true"
                      title="${c.name}"
                      onclick="selectColor('${c.color}')"
                      ondragstart="dragStart(event, '${c.color}')"></div>`
            ).join('');
        }

        function selectColor(color) {
            state.currentColor = color;
            document.getElementById('customColor').value = color;
            document.getElementById('hexInput').value = color;
            
            document.querySelectorAll('.color-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.color === color) {
                    item.classList.add('active');
                }
            });
        }

        function dragStart(e, color) {
            e.dataTransfer.setData('color', color);
        }

        function updateState() {
            state.rows = parseInt(document.getElementById('rows').value);
            state.cols = parseInt(document.getElementById('cols').value);
            state.ledsPerStrip = parseInt(document.getElementById('ledsPerStrip').value);
            state.startCorner = parseInt(document.getElementById('startCorner').value);
            state.zigzag = document.getElementById('zigzag').checked;
            state.brightness = parseInt(document.getElementById('brightness').value);
            
            generateCoordinates();
            generatePreview();
            updateSelectedList();
            updateZigzagInfo();
        }

        function updateZigzagInfo() {
            const info = document.getElementById('zigzagInfo');
            
            if (state.zigzag) {
                info.innerHTML = `
                    <div class="wiring-diagram">
                        <h4>üîå Sambungan Serpentine (Zigzag):</h4>
                        <div class="wire-example">
        <span class="wire-line">Strip 1 (Row 1)</span>
        <span class="wire-line"><span class="wire-data">DI</span>‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí<span class="wire-data">DO</span></span>
        <span class="wire-line">[0][1][2][3]...[${state.ledsPerStrip-1}]</span>
        <span class="wire-line">                ‚Üì</span>
        <span class="wire-line">         kabel pendek</span>
        <span class="wire-line">                ‚Üì</span>
        <span class="wire-line">Strip 2 (Row 2)</span>
        <span class="wire-line"><span class="wire-data">DO</span>‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê‚Üê<span class="wire-data">DI</span></span>
        <span class="wire-line">[${state.ledsPerStrip*2-1}]...[${state.ledsPerStrip+1}][${state.ledsPerStrip}]</span>

        <span class="wire-arrow">‚úÖ Arah bolak-balik horizontal</span>
        <span class="wire-arrow">‚úÖ Kabel pendek antar strip</span>
        <span class="wire-arrow">‚úÖ Hemat kabel</span>
                        </div>
                    </div>
                `;
            } else {
                info.innerHTML = `
                    <div class="wiring-diagram">
                        <h4>üîå Sambungan Linear (Normal):</h4>
                        <div class="wire-example">
        <span class="wire-line">Strip 1 (Row 1)</span>
        <span class="wire-line"><span class="wire-data">DI</span>‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí<span class="wire-data">DO</span></span>
        <span class="wire-line">[0][1][2][3]...[${state.ledsPerStrip-1}]</span>
        <span class="wire-line">                </span>
        <span class="wire-line">Strip 2 (Row 2)</span>
        <span class="wire-line"><span class="wire-data">DI</span>‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí‚Üí<span class="wire-data">DO</span></span>
        <span class="wire-line">[${state.ledsPerStrip}][${state.ledsPerStrip+1}]...[${state.ledsPerStrip*2-1}]</span>

        <span class="wire-arrow">‚ö†Ô∏è Arah sama semua</span>
        <span class="wire-arrow">‚ö†Ô∏è Kabel panjang kembali ke awal</span>
        <span class="wire-arrow">‚úÖ Mudah debug</span>
                        </div>
                    </div>
                `;
            }
        }

        function generateCoordinates() {
            state.coordinates = [];
            let index = 0;
            
            for (let row = 0; row < state.rows; row++) {
                const isReverse = state.zigzag && row % 2 === 1;
                
                for (let col = 0; col < state.cols; col++) {
                    for (let led = 0; led < state.ledsPerStrip; led++) {
                        let x, y;
                        
                        if (state.startCorner === 0) { // bottom-left
                            if (isReverse) {
                                x = (state.cols - 1 - col) * state.ledsPerStrip + (state.ledsPerStrip - 1 - led);
                            } else {
                                x = col * state.ledsPerStrip + led;
                            }
                            y = state.rows - 1 - row;
                            
                        } else if (state.startCorner === 1) { // bottom-right
                            if (isReverse) {
                                x = col * state.ledsPerStrip + led;
                            } else {
                                x = (state.cols - 1 - col) * state.ledsPerStrip + (state.ledsPerStrip - 1 - led);
                            }
                            y = state.rows - 1 - row;
                            
                        } else if (state.startCorner === 2) { // top-left
                            if (isReverse) {
                                x = (state.cols - 1 - col) * state.ledsPerStrip + (state.ledsPerStrip - 1 - led);
                            } else {
                                x = col * state.ledsPerStrip + led;
                            }
                            y = row;
                            
                        } else { // top-right
                            if (isReverse) {
                                x = col * state.ledsPerStrip + led;
                            } else {
                                x = (state.cols - 1 - col) * state.ledsPerStrip + (state.ledsPerStrip - 1 - led);
                            }
                            y = row;
                        }
                        
                        state.coordinates.push({ index, x, y });
                        index++;
                    }
                }
            }
        }

        function generatePreview() {
            const grid = document.getElementById('ledGrid');
            const totalCols = state.cols * state.ledsPerStrip;
            const totalRows = state.rows;
            
            grid.style.gridTemplateColumns = `repeat(${totalCols}, 25px)`;
            grid.style.gridTemplateRows = `repeat(${totalRows}, 25px)`;
            grid.innerHTML = '';
            
            const ledsByPosition = {};
            state.coordinates.forEach(coord => {
                const key = `${coord.x},${coord.y}`;
                ledsByPosition[key] = coord.index;
            });
            
            for (let row = 0; row < totalRows; row++) {
                for (let col = 0; col < totalCols; col++) {
                    const key = `${col},${row}`;
                    const ledIndex = ledsByPosition[key];
                    
                    if (ledIndex !== undefined) {
                        const led = document.createElement('div');
                        led.className = 'led';
                        led.dataset.index = ledIndex;
                        
                        const color = state.selectedLeds[ledIndex];
                        if (color) {
                            led.style.background = color;
                            led.classList.add('selected');
                        }
                        
                        led.ondragover = (e) => e.preventDefault();
                        led.ondrop = (e) => {
                            e.preventDefault();
                            const color = e.dataTransfer.getData('color');
                            setLedColor(ledIndex, color);
                        };
                        led.onclick = () => setLedColor(ledIndex, state.currentColor);
                        
                        const numLabel = document.createElement('div');
                        numLabel.className = 'led-number';
                        numLabel.textContent = ledIndex;
                        led.appendChild(numLabel);
                        
                        grid.appendChild(led);
                    }
                }
            }
            
            updateInfo();
        }

        function setLedColor(index, color) {
            if (state.selectedLeds[index] === color) {
                delete state.selectedLeds[index];
            } else {
                state.selectedLeds[index] = color;
            }
            
            const led = document.querySelector(`[data-index="${index}"]`);
            if (state.selectedLeds[index]) {
                led.style.background = color;
                led.classList.add('selected');
            } else {
                led.style.background = '#555';
                led.classList.remove('selected');
            }
            
            updateSelectedList();
        }

        function selectAll() {
            state.coordinates.forEach(coord => {
                state.selectedLeds[coord.index] = state.currentColor;
            });
            generatePreview();
            updateSelectedList();
        }

        function clearSelection() {
            state.selectedLeds = {};
            generatePreview();
            updateSelectedList();
        }

        function updateSelectedList() {
            const list = document.getElementById('selectedList');
            const selected = Object.entries(state.selectedLeds).sort((a, b) => a[0] - b[0]);
            
            if (selected.length === 0) {
                list.innerHTML = '<div style="color: #999; text-align: center; padding: 20px;">Belum ada LED terpilih</div>';
            } else {
                list.innerHTML = selected.map(([index, color]) => {
                    const coord = state.coordinates[index];
                    return `
                        <div class="selected-item">
                            <div class="selected-item-info">
                                <div class="color-preview" style="background: ${color}"></div>
                                <span>LED ${index} (${coord.x}, ${coord.y})</span>
                            </div>
                            <button class="remove-btn" onclick="setLedColor(${index}, '${color}')">√ó</button>
                        </div>
                    `;
                }).join('');
            }
        }

        function updateInfo() {
            document.getElementById('totalLeds').textContent = state.coordinates.length;
            document.getElementById('selectedCount').textContent = Object.keys(state.selectedLeds).length;
        }

        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : null;
        }

        function showStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.getElementById('rows').addEventListener('input', updateState);
        document.getElementById('cols').addEventListener('input', updateState);
        document.getElementById('ledsPerStrip').addEventListener('input', updateState);
        document.getElementById('startCorner').addEventListener('change', updateState);
        document.getElementById('zigzag').addEventListener('change', updateState);

        document.getElementById('brightness').addEventListener('input', (e) => {
            state.brightness = parseInt(e.target.value);
            document.getElementById('brightnessValue').textContent = e.target.value;
        });

        document.getElementById('customColor').addEventListener('input', (e) => {
            state.currentColor = e.target.value;
            document.getElementById('hexInput').value = e.target.value;
        });

        document.getElementById('hexInput').addEventListener('input', (e) => {
            const hex = e.target.value;
            if (/^#[0-9A-F]{6}$/i.test(hex)) {
                state.currentColor = hex;
                document.getElementById('customColor').value = hex;
            }
        });

        // Initialize - Load dari Arduino dulu sebelum render default
        async function init() {
            initColorPalette();
            selectColor('#ff0080');
            
            try {
                // Coba load dari Arduino dulu
                await loadFromArduino();
            } catch (error) {
                // Kalau gagal, pakai default
                console.log('Gagal load dari Arduino, pakai default');
                updateState();
            }
        }

        // Panggil saat DOM ready
        init();
    </script>
</body>
</html>